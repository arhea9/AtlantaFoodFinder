<!DOCTYPE html>
<html>
<head>
    <title>Restaurant Finder</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD5MEhM_JZWoMAyUrWAbDSX8ATypigqRHI&libraries=places"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        .container {
            display: flex;
            height: 100vh;
        }
        #map {
            flex: 2;
            height: 100%;
        }
        #search {
            flex: 1;
            padding: 20px;
            background: #f8f8f8;
            overflow-y: auto;
        }
        form {
            margin: 0;
        }
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 8px;
            margin: 4px 0 12px;
        }
        input[type="submit"] {
            padding: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        input[type="submit"]:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="search">
            <h2>Search for Restaurants</h2>
            <form method="get" action="{% url 'map' %}">
                <label for="query">Name:</label>
                <input type="text" id="query" name="query" value="{{ request.GET.query }}"><br>

                <label for="cuisine">Cuisine:</label>
                <input type="text" id="cuisine" name="cuisine" value="{{ request.GET.cuisine }}"><br>

                <label for="location">Location:</label>
                <input type="text" id="location" name="location" value="{{ request.GET.location }}"><br>

                <label for="min_rating">Min Rating:</label>
                <input type="number" id="min_rating" name="min_rating" min="0" max="5" value="{{ request.GET.min_rating }}"><br>

                <label for="max_distance">Max Distance (km):</label>
                <input type="number" id="max_distance" name="max_distance" min="0" value="{{ request.GET.max_distance }}"><br>

                <input type="submit" value="Search">
            </form>

            <h3>Results</h3>
            <ul>
                {% for restaurant in restaurants %}
                    <li>{{ restaurant.name }} - Rating: {{ restaurant.rating }} - Address: {{ restaurant.address }}</li>
                {% empty %}
                    <li>No restaurants found.</li>
                {% endfor %}
            </ul>
        </div>

        <div id="map"></div>
    </div>

    <script>
        let map;
        let infowindow;
        let service;
        let userLocation = null;
        let defaultLocation = {lat: 33.776389, lng: -84.3875}; // Scheller College coordinates

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 12,
                center: defaultLocation
            });

            infowindow = new google.maps.InfoWindow();
            service = new google.maps.places.PlacesService(map);

        // Add markers for filtered restaurants
            {% for restaurant in restaurants %}
                (function(restaurant) {
                    let marker = new google.maps.Marker({
                        position: {lat: {{ restaurant.latitude }}, lng: {{ restaurant.longitude }}},
                        map: map,
                        title: '{{ restaurant.name }}',
                        icon: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'
                    });

                // When a marker is clicked, show the restaurant's details
                    google.maps.event.addListener(marker, 'click', function() {
                        getPlaceDetails('{{ restaurant.place_id }}', marker);
                    });
                })({{ restaurant|safe }});
            {% endfor %}
        }

        function handleLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                // Center the map to the user's location
                    map.setCenter(userLocation);

                // Place only one blue marker (user location)
                    new google.maps.Marker({
                        position: userLocation,
                        map: map,
                        title: 'Your Location',
                        icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                    });
                }, function() {
                // If user location fails, default to Scheller
                    map.setCenter(defaultLocation);

                // Place default blue marker for Scheller
                    new google.maps.Marker({
                        position: defaultLocation,
                        map: map,
                        title: 'Scheller College of Business',
                        icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                    });
                });
            } else {
            // If geolocation is not supported, default to Scheller
                map.setCenter(defaultLocation);

                new google.maps.Marker({
                    position: defaultLocation,
                    map: map,
                    title: 'Scheller College of Business',
                    icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                });
            }
        }

        function getCuisineType(types) {
    const cuisineTypes = {
        'restaurant': 'Various', // Default or broad category
        'cafe': 'Cafe',
        'meal_takeaway': 'Takeaway',
        'bar': 'Bar',
        'bakery': 'Bakery',
        'food': 'Food',
        // Add more mappings as needed
    };

    // Find the first matching type
    for (let type of types) {
        if (cuisineTypes[type]) {
            return cuisineTypes[type];
        }
    }

    return 'Unknown'; // Default if no matching type
}

    // Function to get detailed information about a place
        function getPlaceDetails(placeId, marker) {
            service.getDetails({placeId: placeId}, function(place, status) {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    let content = `
                        <h3>${place.name}</h3>
                        <p><strong>Address:</strong> ${place.formatted_address}</p>
                        <p><strong>Rating:</strong> ${place.rating}</p>
                        <p><strong>Cuisine:</strong> ${getCuisineType(place.types)}</p>
                        <p><strong>Reviews:</strong></p>
                        <ul>
                            ${place.reviews.map(review => `<li>${review.text} - ${review.author_name}</li>`).join('')}
                        </ul>
                        <a href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(place.formatted_address)}" target="_blank">Get Directions</a>
                    `;
                    infowindow.setContent(content);
                    infowindow.open(map, marker);
                } else {
                    infowindow.setContent("Details not found.");
                    infowindow.open(map, marker);
                }
            });
        }

        google.maps.event.addDomListener(window, 'load', function() {
            initMap();
            handleLocation();
        });
    </script>
</body>
</html>


