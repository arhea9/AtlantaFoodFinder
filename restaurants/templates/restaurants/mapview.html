<!DOCTYPE html>
<html>
<head>
    {% load static %}
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <link rel="stylesheet" type="text/css" href="{% static 'restaurants/mapview.css' %}" />
    <!-- Google Maps API with Places Library -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD5MEhM_JZWoMAyUrWAbDSX8ATypigqRHI&libraries=places&callback=initMap" async defer></script>
</head>
<body>
    <header>
        <div class="logo-container">
            <img src="{% static 'restaurants/images/logo.png' %}" alt="Atlanta Food Finder" class="logo">
        </div>
    </header>

    <div class="container">
        <div class="sidebar">
            <div class="search-bar">
                <input type="text" id="search" placeholder="Search for a restaurant">
                <button id="filter-btn">
                    <img src="{% static 'restaurants/images/filter-icon.png' %}" alt="Filter">
                </button>
            </div>
            <h3>Top Results</h3>
            <div class="restaurant-list" id="restaurant-list">
                <!-- Dynamic list of restaurants will be inserted here -->
            </div>
        </div>

        <div id="map" class="map"></div>
    </div>
<script>
let map;
let service;
let favorites = [];
let infoWindow; // Declare a variable to hold the InfoWindow instance
let markers = []; // Keep track of markers

function initMap() {
    const atlanta = { lat: 33.749, lng: -84.388 };

    // Initialize the map centered on Atlanta
    map = new google.maps.Map(document.getElementById('map'), {
        center: atlanta,
        zoom: 12
    });

    // Initialize the InfoWindow
    infoWindow = new google.maps.InfoWindow();

    // Request object for the Google Places API
    const request = {
        location: atlanta,
        radius: '5000', // 5 km radius
        type: ['restaurant']
    };

    // Initialize the Places service
    service = new google.maps.places.PlacesService(map);

    // Perform nearby search to get restaurants
    service.nearbySearch(request, handleSearchResults);
}

function getCuisineType(place) {
    const cuisineMap = {
        'chinese': 'Chinese',
        'italian': 'Italian',
        'japanese': 'Japanese',
        'mexican': 'Mexican',
        'thai': 'Thai',
        'indian': 'Indian',
        'korean': 'Korean',
        'vietnamese': 'Vietnamese',
        'greek': 'Greek',
        'french': 'French',
        'spanish': 'Spanish',
        'american': 'American',
    };

    const types = place.types || [];

    const cuisines = types
        .map(type => cuisineMap[type.toLowerCase()] || null)
        .filter(cuisine => cuisine !== null);

    // Return empty string if no cuisine types are found
    return cuisines.length > 0 ? `Cuisine: ${cuisines.join(', ')}` : 'Not Specified';
}


function handleSearchResults(results, status) {
    if (status === google.maps.places.PlacesServiceStatus.OK) {
        const restaurantList = document.getElementById('restaurant-list');
        restaurantList.innerHTML = ''; // Clear previous results
        clearMarkers(); // Clear previous markers

        results.forEach((place) => {
            // Add marker for each restaurant on the map
            const marker = new google.maps.Marker({
                map: map,
                position: place.geometry.location,
                title: place.name
            });

            markers.push(marker); // Add marker to the array

            const restaurantItem = document.createElement('div');
            restaurantItem.className = 'restaurant-item';
            restaurantItem.innerHTML = `
                <div class="icon favorite" data-id="${place.place_id}">☆</div>
                <div class="restaurant-info">
                    <h3>${place.name}</h3>
                    <a href="#" class="details-link" data-id="${place.place_id}">See Details</a>
                </div>
            `;

            // Add event listener to center the map on restaurant when clicked
            restaurantItem.addEventListener('click', () => {
                map.panTo(place.geometry.location);
                map.setZoom(17);
            });

            // Add event listener to show details when "See Details" is clicked
            restaurantItem.querySelector('.details-link').addEventListener('click', function(event) {
                event.preventDefault(); // Prevent default link behavior

                const placeId = this.getAttribute('data-id');

                // Fetch detailed information about the place
                service.getDetails({ placeId: placeId }, (placeDetails, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK) {
                        const cuisine = getCuisineType(placeDetails);
                        const address = placeDetails.formatted_address || 'Address not available';
                        const rating = placeDetails.rating || 'Rating not available';
                        const phone = placeDetails.formatted_phone_number || 'Phone number not available';
                        const reviews = placeDetails.reviews?.slice(0, 3).map(review => `<p>"${review.text}" - ${review.author_name}</p>`).join('') || 'No reviews available';

                        // Set the content for the InfoWindow
                        infoWindow.setContent(`
                            <div>
                                <h3>${placeDetails.name}</h3>
                                <p><strong>Cuisine:</strong> ${cuisine}</p>
                                <p><strong>Address:</strong> ${address}</p>
                                <p><strong>Rating:</strong> ${rating}</p>
                                <p><strong>Phone:</strong> ${phone}</p>
                                <div><strong>Reviews:</strong>${reviews}</div>
                                <button id="see-more" class="btn">See More</button>
                            </div>
                        `);

                        // Open the InfoWindow at the restaurant's location
                        infoWindow.open(map, marker);

                        google.maps.event.addListenerOnce(infoWindow, 'domready', () => {
                        document.getElementById('see-more').addEventListener('click', () => {
                        // Open the restaurant's Google Maps page in a new tab
                        window.open(`https://www.google.com/maps/place/?q=place_id:${placeDetails.place_id}`, '_blank');
                        });
                    });
                }
            });
        });

            // Add event listener to toggle favorite status
            restaurantItem.querySelector('.favorite').addEventListener('click', function(event) {
                event.stopPropagation(); // Prevent triggering the restaurant click event
                const placeId = this.getAttribute('data-id');

                // Toggle favorite status
                if (favorites.includes(placeId)) {
                    favorites = favorites.filter(id => id !== placeId);
                    this.textContent = '☆'; // Change to hollow star
                } else {
                    favorites.push(placeId);
                    this.textContent = '★'; // Change to filled star
                }

                console.log('Favorites:', favorites); // Debug: log favorites
            });

            restaurantList.appendChild(restaurantItem);
        });
    }
}

// Clear all previous markers from the map
function clearMarkers() {
    markers.forEach(marker => marker.setMap(null)); // Remove each marker from the map
    markers = []; // Clear the array of markers
}
window.onload = initMap;
</script>
</body>
</html>
