<!DOCTYPE html>
<html>
<head>
    {% load static %}
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <link rel="stylesheet" type="text/css" href="{% static 'restaurants/mapview.css' %}" />
    <!-- Google Maps API with Places Library -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD5MEhM_JZWoMAyUrWAbDSX8ATypigqRHI&libraries=places&callback=initMap" async defer></script>
</head>
<body>
    <header>
        <div class="logo-container">
            <img src="{% static 'restaurants/images/logo.png' %}" alt="Atlanta Food Finder" class="logo">
        </div>
    </header>

    <div class="container">
        <div class="sidebar">
            <div class="search-bar">
                <input type="text" id="search" placeholder="Search for a restaurant">
                <button id="filter-btn">
                    <img src="{% static 'restaurants/images/filter-icon.png' %}" alt="Filter">
                </button>
            </div>
            <h3>Top Results</h3>
            <div class="restaurant-list" id="restaurant-list">
                <!-- Dynamic list of restaurants will be inserted here -->
            </div>
        </div>

        <div id="map" class="map"></div>
    </div>

    <script>
        let map;
        let service;

        function initMap() {
    const atlanta = { lat: 33.749, lng: -84.388 };

    map = new google.maps.Map(document.getElementById('map'), {
        center: atlanta,
        zoom: 12
    });

    loadRestaurantsFromLocalStorage(); // Load from localStorage first

    const request = {
        location: atlanta,
        radius: '5000',
        type: ['restaurant']
    };

    service = new google.maps.places.PlacesService(map);
    console.log("Requesting nearby restaurants...");
    service.nearbySearch(request, handleSearchResults);
}


            google.maps.event.addListener(map, 'center_changed', function() {
        localStorage.setItem('mapCenter', JSON.stringify(map.getCenter().toJSON()));
    });

    google.maps.event.addListener(map, 'zoom_changed', function() {
        localStorage.setItem('mapZoom', map.getZoom());
    });

    function handleSearchResults(results, status) {
    if (status === google.maps.places.PlacesServiceStatus.OK) {
        const restaurantList = document.getElementById('restaurant-list');
        restaurantList.innerHTML = ''; // Clear the list before adding new items

        // Store the results in localStorage
        localStorage.setItem('restaurants', JSON.stringify(results));

        results.forEach((place) => {
            const marker = new google.maps.Marker({
                map: map,
                position: place.geometry.location,
                title: place.name
            });

            const restaurantItem = document.createElement('div');
            restaurantItem.className = 'restaurant-item';
            restaurantItem.innerHTML = `
                <div class="icon">★</div>
                <div class="restaurant-info">
                    <p>Cuisine: ${getCuisineType(place)}</p>
                    <h3>${place.name}</h3>
                    <a href="#">See Details</a>
                </div>
            `;

            restaurantItem.addEventListener('click', () => {
                map.setCenter(place.geometry.location);
                map.setZoom(15);
            });

            restaurantList.appendChild(restaurantItem);
        });
    } else {
        // Load from localStorage if the API call fails
        loadRestaurantsFromLocalStorage();
    }
}

function loadRestaurantsFromLocalStorage() {
    const storedRestaurants = localStorage.getItem('restaurants');
    if (storedRestaurants) {
        const results = JSON.parse(storedRestaurants);
        const restaurantList = document.getElementById('restaurant-list');
        restaurantList.innerHTML = ''; // Clear the list before adding new items

        results.forEach((place) => {
            const marker = new google.maps.Marker({
                map: map,
                position: place.geometry.location,
                title: place.name
            });

            const restaurantItem = document.createElement('div');
            restaurantItem.className = 'restaurant-item';
            restaurantItem.innerHTML = `
                <div class="icon">★</div>
                <div class="restaurant-info">
                    <p>Cuisine: ${getCuisineType(place)}</p>
                    <h3>${place.name}</h3>
                    <a href="#">See Details</a>
                </div>
            `;

            restaurantItem.addEventListener('click', () => {
                map.setCenter(place.geometry.location);
                map.setZoom(15);
            });

            restaurantList.appendChild(restaurantItem);
        });
    }
}


        // Function to extract cuisine type from place types
        function getCuisineType(place) {
            // For simplicity, return 'Restaurant' or other type as cuisine
            return place.types.includes('restaurant') ? 'Restaurant' : 'Cuisine';
        }
    </script>
</body>
</html>
